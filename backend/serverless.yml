service: serverless-chat-app-api
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs12.x
  region: ap-southeast-1
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/chatAppTable"

plugins:
  - serverless-appsync-plugin

custom:
  appSync:
    name: chatAppAppSync
    authenticationType: API_KEY
    mappingTemplatesLocation: resolvers
    mappingTemplates:
      - dataSource: RawTable
        type: Query
        field: getUserById
      - dataSource: RawTable
        type: Query
        field: getAllUsers
      - dataSource: RawTable
        type: Mutation
        field: createUser
      - dataSource: RawTable
        type: Mutation
        field: deleteUser
      - dataSource: RawTable
        type: Mutation
        field: updateUser
      - dataSource: RawTable
        type: Query
        field: getAllMessages
    additionalAuthenticationProviders:
      - authenticationType: AWS_IAM
    dataSources:
      - type: AMAZON_DYNAMODB
        name: RawTable
        config:
          tableName: chatAppTable

resources:
  Resources:
    RawTable:
      Type: "AWS::DynamoDB::Table"
      Properties:
        TableName: chatAppTable
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5
    # UserPool:
    #   Type: AWS::Cognito::Userpool
    #   Properties:
    #     UserPoolName: ChatAppUser
    #     AdminCreateUserConfig:
    #       AllowAdminCreateUseronly: false
    #     AutoverifiedAttributes:
    #       - phone_number
    #       - email
    #     MfaConfiguration: OPTIONAL
    #     Schema:
    #       - AttributeDataType: String
    #         Mutable: true
    #         Name: type
    #       - AttributeDataType: String
    #         Mutable: true
    #         Name: roles
    #     Policies:
    #       PasswordPolicy:
    #         RequireLowercase: false
    #         RequireUppercase: false
    #         RequireSymbols: false
    #         RequireNumbers: false
